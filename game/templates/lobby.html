{% include "base.html" %}
{% load static %}

{% block content %}


<p id = 'user-online'>Number of users online: <span id="user-count"></span></p>
<br>

<textarea id="chat-log" cols="50" rows="10"></textarea><br>
    <input id="chat-message-input" type="text" size="50"><br>
    <input id="chat-message-submit" type="button" value="Send">

<hr>

<button id ='start-game'>start game</button>

<hr>


    {% for question in questions %}
    <div class="container hidden  " id = 'quiz-container' >
    <h1>{{question.text}}</h1>
    <div class="container">
        <div class="row row-cols-2">
          <div class="col" class = "question_A" style="background-color: brown;">{{question.answer1}}</div>
          <div class="col" class = "question_B" style="background-color: rgb(65, 165, 42);">{{question.answer2}}</div>
          <div class="col" class = "question_C" style="background-color: rgb(118, 42, 165);">{{question.answer3}}</div>
          <div class="col" class = "question_D" style="background-color: rgb(155, 165, 42);">{{question.answer4}}</div>
        </div>
      </div>
    </div>

    {% endfor %}


<script >


    const roomCode = '{{room_code}}'
    const user_name = '{{user_name}}'
    const host_name = '{{host_name}}'
    const questions = '{{ questions|safe }}'
    const chat_log = document.getElementById('chat-log');
    const chat_input = document.getElementById('chat-message-input');
    const chat_submit = document.getElementById('chat-message-submit');
    const quiz_container = document.querySelector('#quiz-container')
    const user_count = document.getElementById('user-count')
    const user_online = document.getElementById('user-online')
    let = crrIndex = 0;


    
    console.log(host_name);
    const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/game/'
            + roomCode
            + '/'
        );

        
    
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log(data)


            console.log(data.count)
            document.querySelector('#user-count').innerHTML = data.count;

            switch(data.type) {
                case 'chat_message' : 
                    if(data.message != ''){
                        chat_log.innerHTML = chat_log.value + data.user_name + " : " +  data.message + "\n"
                    }
                case 'number_user_message':
                    user_count.innerHTML = data.count
                case 'start_game_message':
                    if(data.run == 'true') {
                        game_running()
                    }
                case 'leave_room_message':
            }
            
    
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        $(document).ready(function() {
            $('.col').on('click', function() {
                alert('Bạn đã trả lời câu hỏi');
                const msg = {
                    type : 'submit_answer',
                    
                }

            
            });
        });


        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        chatSocket.onopen = function(event) {
        
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            const msg = {
                type : 'chat',
                text : message,
            }
            chatSocket.send(JSON.stringify(msg));
            messageInputDom.value = '';
        };

        document.querySelector('#start-game').onclick = function(e) {
                if(user_name == host_name) {
                    const msg = {
                        type : 'start_game',
                        run : 'true',
                    }
                    chatSocket.send(JSON.stringify(msg));
                }
        }

 


        function game_running() {
            chat_input.classList.add('hidden')
            chat_submit.classList.add('hidden')
            chat_log.classList.add('hidden')
            quiz_container.classList.remove('hidden')
            user_online.classList.add('hidden')
        }

        window.addEventListener('beforeunload', function(event) {
            const msg = {
                type : 'leave_room',
            }
            websocket.send(JSON.stringify(msg));
        });
        

</script>


{% endblock%}